# Stripe後日課金の仕組み（概要版）

## 目的
申込み日（11日）にカード情報を登録し、実際の課金は後日（12月1日）に自動で行う仕組み。

---

## ユーザーの流れ

### 【11月11日：申込み日】
1. ユーザーがカード情報を入力
2. カードの有効性を確認（3Dセキュア認証など）
3. **この時点では課金されない（0円）**
4. 「12月1日に課金されます」という確認メッセージを表示

### 【12月1日：課金日】
1. **ユーザーは何もしない**
2. システムが自動で決済を実行
3. カードから引き落とし
4. 決済完了メールを送信

---

## 採用する方法：SetupIntent + PaymentMethod

### メリット
- ✅ **期間制限なし**（何日後でも、月をまたいでもOK）
- ✅ **ユーザーは登録時のみ操作、後は完全自動**
- ✅ すべてのカードブランドで利用可能
- ✅ 追加の価格プランや特別な条件不要

### 仕組み
1. **SetupIntent**：カード情報を保存（課金なし）
2. **PaymentMethod**：保存されたカード情報のID
3. **PaymentIntent**：後日、保存したカード情報で自動課金

---

## 別の方法：Authorization and Capture

### 概要
カードを仮押さえして、後日本課金する方法。

### 制約
- ⚠️ **通常は7日間のみ有効**
- ⚠️ 延長（最大30日）には特別な価格プランが必要
- ⚠️ 対応カードブランドに制限あり

### 結論
**期間が17〜20日間あるため、この方法は不適切**

---

## 注意点

### 1. 顧客への明示
- 申込み時に「後日課金」を明確に伝える
- 課金日を利用規約やメールで通知
- 課金前日にリマインドメールを送ると親切

### 2. 決済失敗のリスク
以下の理由で決済が失敗する可能性があります：
- カードの有効期限切れ
- 残高不足
- カード停止

**対策：**
- エラー時の自動リトライ
- ユーザーへのメール通知
- カード情報の再登録フロー

### 3. 法的・規約面
- 後日課金について利用規約に明記
- 同意を得てからカード情報を保存
- プライバシーポリシーでデータ保管方法を説明

---

## 実装の難易度
- **フロントエンド**：中（Stripe Elementsの実装）
- **バックエンド**：中（API連携とcron job設定）
- **テスト**：重要（本番前に十分なテストが必要）

---

## 推奨スケジュール
1. **仕様確定**：利用規約・UI設計（1〜2日）
2. **開発**：実装とテスト（3〜5日）
3. **テスト環境での検証**：実際の日付をまたいだテスト（2〜3日）
4. **本番リリース**

---

## 参考情報
- Stripe公式ドキュメント：https://docs.stripe.com/payments/save-and-reuse
- サポート：https://support.stripe.com

---

**作成日：2025年10月31日**
